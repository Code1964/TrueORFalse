{% extends "base.html" %}
{% load static %}

{% block meta %}
    <meta name="twitter:card" content="summary" />
    <meta property="og:url" content="{{ site_url }}" />
    <meta property="og:title" content="うそGPT" />
    <meta property="og:description" content="ChatGPTの嘘を見抜くためのサイトです" />
    <meta property="og:image" content="{% static image_url %}" />
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script>
        let json = "{{ data|safe }}";
    </script>
{% endblock %}

{% block title %}結果発表{% endblock %}

{% block content %}
<div class="card text-center d-flex flex-column justify-content-center">
    <div class="card-header">
        <h2>あなたの得点は...</h2>
    </div>
    <div class="card-body">
        <img src="{% static image_url %}" alt="Rabbit Image" width="200" height="200">
        <h1 class="card-title">{{ point }}点！</h1>
        <p class="card-text">{{ result_text }}</p>
        <a class="btn btn-primary" href="https://twitter.com/intent/tweet?text=あなたの点数は{{ point }}点です！&url={{ site_url }}"
        target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16">
                <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
            </svg>
            Share on X
        </a>
        <a href="/difficulty" class="btn btn-primary">もう一度プレイする</a>
        {% if json_data %}
        <h1>問題一覧</h1>
            {% for data in json_data %}
            <div class="accordion" id="accordion{{ forloop.counter }}">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                            {{ data.question }}
                        </button>
                    </h2>
                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}">
                        <div class="accordion-body">
                            <p>回答: {{ data.answer }}</p>
                            <p>ヒント: {{ data.hints|join:", " }}</p>
                            <p>解説: {{ data.commentary }}</p>
                            {% if data.falsification_answer == "T" %}
                                <p>嘘か本当かを表す英文字: {{ data.falsification_answer }}</p>
                                <p>真実の解説: {{ data.true_commentary }}</p>
                            {% endif %}
                            <form id="ajax-file-send" action="{% url 'game:saveDB' %}" method="post">
                                {% csrf_token %}
                                <!-- この書き方絶対に良くない(バグの温床) -->
                                <input type="hidden" id="jsonData" value="{{ data|safe }}">
                                <button type="button" id="saveButton" class="btn btn-primary">データを保存</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>嘘がバレるのを恐れて問題を表示させませんでした</p>
        {% endif %}
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const saveButton = document.getElementById("saveButton");
        saveButton.addEventListener("click", function() {
            const jsonData = document.getElementById("jsonData").value;
            saveDB(jsonData);
        });
    });
    function saveDB(data) {
        const saveUrl = "{% url 'game:saveDB' %}";
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        // JSONデータ化
        const jsonDataStr = JSON.stringify(data);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/result/saveDB" , true);
        // これしても文字化けする
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.setRequestHeader("X-CSRFToken", csrfToken);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    alert("データが保存されました");
                    // ボタンを無効化
                    document.getElementById("saveButton").disabled = true;
                    document.getElementById("saveButton").style.display = "none";
                } else {
                    alert("データの保存に失敗しました");
                }
            }
        };
        // これをしても文字化けする
        // // JSON文字列をパースしてオブジェクトに変換
        // const jsonDataObj = JSON.parse(jsonDataStr);
        // // オブジェクトを文字列化して送信
        // xhr.send(JSON.stringify(jsonDataObj));
        xhr.send(jsonDataStr);
    }
</script>
{% endblock %}